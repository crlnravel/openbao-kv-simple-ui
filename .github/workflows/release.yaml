name: Release

on:
  push:
    tags:
      - 'v*.*.*-dev.*' # Dev releases: v1.0.0-dev.1
      - 'v*.*.*-staging.*' # Staging releases: v1.0.0-staging.1
      - 'v*.*.*-rc.*' # Release candidates (staging): v1.0.0-rc.1
      - 'v[0-9]+.[0-9]+.[0-9]+' # Production releases: v1.0.0

env:
  REGISTRY: docker.io
  IMAGE_NAME: claudexter/openbao-kv-simple-ui
  INFRA_REPO: pandatechid/HGK0-infra
  APP_NAME: openbao-ui
  NODE_VERSION: "22"
  PNPM_VERSION: "9"

jobs:
  determine-environment:
    name: Determine Environment
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.env.outputs.environment }}
      image_tag: ${{ steps.env.outputs.image_tag }}
      auto_deploy: ${{ steps.env.outputs.auto_deploy }}
    steps:
      - name: Determine environment from tag
        id: env
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          echo "Processing tag: $TAG"

          if [[ "$TAG" =~ ^v[0-9]+\.[0-9]+\.[0-9]+-dev\. ]]; then
            echo "environment=dev" >> $GITHUB_OUTPUT
            echo "auto_deploy=true" >> $GITHUB_OUTPUT
          elif [[ "$TAG" =~ ^v[0-9]+\.[0-9]+\.[0-9]+-(staging|rc)\. ]]; then
            echo "environment=staging" >> $GITHUB_OUTPUT
            echo "auto_deploy=true" >> $GITHUB_OUTPUT
          elif [[ "$TAG" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "environment=prod" >> $GITHUB_OUTPUT
            echo "auto_deploy=false" >> $GITHUB_OUTPUT
          else
            echo "Unknown tag format: $TAG"
            exit 1
          fi

          echo "image_tag=$TAG" >> $GITHUB_OUTPUT

  validate-promotion:
    name: Validate Promotion
    runs-on: ubuntu-latest
    needs: determine-environment
    if: needs.determine-environment.outputs.environment == 'staging'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Verify dev tag exists for this version
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          # Strip -staging.* or -rc.* suffix to get version prefix
          VERSION_PREFIX=$(echo "$TAG" | sed -E 's/-(staging|rc)\..*//')
          echo "Looking for dev tags matching: ${VERSION_PREFIX}-dev.*"

          if git tag -l "${VERSION_PREFIX}-dev.*" | grep -q .; then
            echo "Found matching dev tag(s):"
            git tag -l "${VERSION_PREFIX}-dev.*"
          else
            echo "No dev tag found for ${VERSION_PREFIX}. A dev release must exist before promoting to staging."
            exit 1
          fi

  build:
    name: Build Application
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build application
        run: pnpm run build

  build-and-push:
    name: Build and Push Image
    runs-on: ubuntu-latest
    needs: [determine-environment, build, validate-promotion]
    if: always() && (needs.validate-promotion.result == 'success' || needs.validate-promotion.result == 'skipped')
    permissions:
      contents: read
      packages: write
    outputs:
      image_digest: ${{ steps.build.outputs.digest }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Set up Docker Buildx with Build Cloud
        uses: docker/setup-buildx-action@v3
        with:
          driver: cloud
          endpoint: ${{ vars.DOCKER_BUILD_CLOUD_ENDPOINT }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE_NAME }}
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=raw,value=${{ needs.determine-environment.outputs.image_tag }}
            type=sha,prefix=sha-

      - name: Build and push
        id: build
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            VERSION=${{ needs.determine-environment.outputs.image_tag }}
            COMMIT_SHA=${{ github.sha }}

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: '${{ env.IMAGE_NAME }}:${{ needs.determine-environment.outputs.image_tag }}'
          format: 'table'
          severity: 'CRITICAL,HIGH'

  update-infra:
    name: Update Infrastructure Repository
    runs-on: ubuntu-latest
    needs: [determine-environment, build-and-push]
    if: always() && needs.build-and-push.result == 'success' && needs.determine-environment.outputs.auto_deploy == 'true'
    environment: ${{ needs.determine-environment.outputs.environment }}
    steps:
      - name: Checkout infra repository
        uses: actions/checkout@v4
        with:
          repository: ${{ env.INFRA_REPO }}
          token: ${{ secrets.INFRA_REPO_TOKEN }}
          path: infra

      - name: Update image tag in values file
        run: |
          ENV="${{ needs.determine-environment.outputs.environment }}"
          TAG="${{ needs.determine-environment.outputs.image_tag }}"
          VALUES_FILE="infra/values/apps/${{ env.APP_NAME }}/${ENV}.yaml"

          echo "Updating $VALUES_FILE with tag: $TAG"

          if [ -f "$VALUES_FILE" ]; then
            # Update the image tag in the values file
            sed -i "s|tag:.*|tag: \"${TAG}\"|g" "$VALUES_FILE"

            echo "Updated values file:"
            cat "$VALUES_FILE"
          else
            echo "Values file not found: $VALUES_FILE"
            exit 1
          fi

      - name: Create Pull Request
        id: create-pr
        uses: peter-evans/create-pull-request@v6
        with:
          path: infra
          token: ${{ secrets.INFRA_REPO_TOKEN }}
          commit-message: |
            chore(${{ env.APP_NAME }}): update image to ${{ needs.determine-environment.outputs.image_tag }}

            Triggered by: ${{ github.repository }}@${{ github.sha }}
            Environment: ${{ needs.determine-environment.outputs.environment }}
          branch: deploy/${{ env.APP_NAME }}/${{ needs.determine-environment.outputs.environment }}/${{ needs.determine-environment.outputs.image_tag }}
          delete-branch: true
          title: '[${{ needs.determine-environment.outputs.environment }}] Deploy ${{ env.APP_NAME }} ${{ needs.determine-environment.outputs.image_tag }}'
          body: |
            ## Automated Deployment PR

            **Application:** ${{ env.APP_NAME }}
            **Environment:** ${{ needs.determine-environment.outputs.environment }}
            **Image Tag:** `${{ needs.determine-environment.outputs.image_tag }}`
            **Image Digest:** `${{ needs.build-and-push.outputs.image_digest }}`

            ### Source
            - Repository: ${{ github.repository }}
            - Commit: ${{ github.sha }}
            - Tag: ${{ github.ref_name }}
            - Actor: @${{ github.actor }}

            ### Changes
            Updates the image tag in `values/apps/${{ env.APP_NAME }}/${{ needs.determine-environment.outputs.environment }}.yaml`

            ---
            _This PR was automatically created by the CI/CD pipeline._
          labels: |
            automated
            deployment
            ${{ needs.determine-environment.outputs.environment }}

      - name: Auto-merge infra PR
        if: needs.determine-environment.outputs.environment != 'prod' && steps.create-pr.outputs.pull-request-number
        env:
          GH_TOKEN: ${{ secrets.INFRA_REPO_TOKEN }}
        run: |
          gh pr merge ${{ steps.create-pr.outputs.pull-request-number }} \
            --repo ${{ env.INFRA_REPO }} \
            --merge --auto

  notify:
    name: Notify
    runs-on: ubuntu-latest
    needs: [determine-environment, build-and-push, update-infra]
    if: always()
    steps:
      - name: Notify on success
        if: needs.update-infra.result == 'success'
        run: |
          echo "✅ Deployment PR created successfully!"
          echo "Environment: ${{ needs.determine-environment.outputs.environment }}"
          echo "Image: ${{ env.IMAGE_NAME }}:${{ needs.determine-environment.outputs.image_tag }}"

      - name: Notify on failure
        if: needs.update-infra.result == 'failure'
        run: |
          echo "❌ Deployment failed!"
          echo "Please check the workflow logs for details."
          exit 1
